<?php
# ****************************************************************************************************************************
# * Last Edit: June 29, 2020
# * - allows for the discovery of items in the catalogue - shows the most recent 30 items added to the system by parameter
# *
# * 06-29-20: base version - CZ
# ****************************************************************************************************************************

# ****************************************************************************************************************************
# * grab the discovery term
# ****************************************************************************************************************************
$limiter = "BK|FICTION|";
if (! empty($_GET['limiter'])) {
  $limiter = $_GET['limiter'];
}

# ****************************************************************************************************************************
# * split apart the limiter to get the itype and collection code pairing
# ****************************************************************************************************************************
$splitLimiter = explode('|', $limiter);

# ****************************************************************************************************************************
# * determine which report to run - date will come back in pairings, either itype/ccode or itype/location
# ****************************************************************************************************************************
$reportNumber = 501; // report for itype/ccode pairing
$paramOne     = $splitLimiter[0];
$paramTwo     = $splitLimiter[1];

if (! empty ($splitLimiter[2])) {
  $reportNumber = 502; // report for itype/location pairing
  $paramTwo     = $splitLimiter[2];
}

# ****************************************************************************************************************************
# * assemble the url to the report
# ****************************************************************************************************************************
$reportURL = 'https://****.bywatersolutions.com/cgi-bin/koha/svc/report?id=' . $reportNumber . '&param_name=itemtype&sql_params=' . $paramOne . '&param_name=ccode&sql_params=' . $paramTwo;

# ****************************************************************************************************************************
# * run the report and grab the JSON
# ****************************************************************************************************************************
$jsonData = json_decode(file_get_contents($reportURL), true);

# ****************************************************************************************************************************
# * loop over the results and build out the array to be passed to the app
# ****************************************************************************************************************************
foreach($jsonData as $obj){

  if (strpos($obj[0], 'Grab') > -1) {
    continue;
  }

# ****************************************************************************************************************************
# * clean up the trailing slash at the end of the title
# ****************************************************************************************************************************
  if(substr(trim($obj[0]), -1) == '/') {
    $obj[0] = substr(trim($obj[0]), 0, -1);
  }

# ****************************************************************************************************************************
# * deal with the ISBN number, send it forward, or clean it up where multiples exist
# ****************************************************************************************************************************
  if (strpos($obj[2], '|') > 0) {
    $isbnValue = explode('|', $obj[2]);
	$obj[2]    = $isbnValue[0];
  }

# ****************************************************************************************************************************
# * provide something if there is no summary
# ****************************************************************************************************************************
  if (empty ($obj[5])) { $obj[5] = "Sorry, there is no summary available for this title."; }

# ****************************************************************************************************************************
# * need to clean up the URL if it's present
# ****************************************************************************************************************************
  $obj[6] = trim($obj[6]);

# ****************************************************************************************************************************
# * Camel case the title
# ****************************************************************************************************************************
  $obj[0] = trim(ucwords($obj[0]));
  
# ****************************************************************************************************************************
# * handle the image - especially if we have a movie
# ****************************************************************************************************************************
  $iconName = 'https://secure.syndetics.com/index.aspx?isbn=' . trim($obj[2]) . '/LC.GIF';
  
# ****************************************************************************************************************************
# * need to massage data for movies
# ****************************************************************************************************************************
  if (strpos($obj[3], 'DVD') > -1) {
	$tempTitle = str_replace(' ', '+', $obj[0]);
    $movieData = json_decode(file_get_contents('http://www.omdbapi.com/?apikey=55f5b2cf&t=' . $tempTitle), true);
	
	$obj[1]   = $movieData['Director'];
	$obj[8]   = $movieData['Plot'];
	$iconName = $movieData['Poster'];
  }
	
  $searchResults['Items'][] = array('title' => $obj[0], 'author' => $obj[1], 'image' => $iconName, 'format' => $obj[3], 'barcode' => $obj[4], 'key' => $obj[4], 'summary' => $obj[5], 'url' => $obj[6]); 
}

# ****************************************************************************************************************************
# * Just in case there are no values to return, check and spit out empty rather than null
# ****************************************************************************************************************************
if (empty($searchResults['Items'])) {
  $searchResults['Items'] = '';
}  

# ****************************************************************************************************************************
# * Output to JSON
# ****************************************************************************************************************************
header('Content-Type: application/json');
echo json_encode($searchResults);
?>