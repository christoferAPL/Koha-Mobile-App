<?php
# ****************************************************************************************************************************
# * Last Edit: June 3, 2020
# * - place holds on items
# *
# * 06-03-20: dummied out the hold location in case something is wrong - CZ
# * 12-18-19: refactored, cleaned up and commented code - CZ
# ****************************************************************************************************************************

# ****************************************************************************************************************************
# * include the required files
# ****************************************************************************************************************************
include_once('config.php');
include_once('sip2.php');

# ****************************************************************************************************************************
# * instanciate the SIP instance
# ****************************************************************************************************************************
$mysip = new sip2;

# ****************************************************************************************************************************
# * connect to SIP service; fail if not succcessful. if we pass this, then connection was successful
# ****************************************************************************************************************************
if(! $mysip->connect()) { 
 die();
}

# ****************************************************************************************************************************
# * Do a quick check to ensure that the login credentials are correct - for SIP
# ****************************************************************************************************************************
$sc_login = $mysip->msgLogin(SIP_LOGIN, SIP_PASSWORD);
$mysip->parseLoginResponse($mysip->get_message($sc_login));
  
# ****************************************************************************************************************************
# * Prep the patron information for checking - dummy out something just in case
# ****************************************************************************************************************************
$barcode  = "thisisadummybarcodeincaseitisleftblank";
$pin      = 1234567890;
$itemCode = 1234567890;

# ****************************************************************************************************************************
# * grab the passed variables
# ****************************************************************************************************************************
if (! empty($_GET['barcode'])) { $barcode = $_GET['barcode']; }
if (! empty($_GET['pin'])) { $pin = $_GET['pin']; }  
if (! empty($_GET['item'])) { $itemCode = $_GET['item']; }  
if (! empty($_GET['location'])) { $location = $_GET['location']; }  

# ****************************************************************************************************************************
# * prepare the location information ... need to set a default in case something goes wrong
# ****************************************************************************************************************************
$shortLocation = 'MAIN';
if ($location == 'Main') { $shortLocation = 'MAIN'; }
if ($location == 'McLean') { $shortLocation = 'MCLEAN'; }
if ($location == 'Audley') { $shortLocation = 'AU'; }
	
# ****************************************************************************************************************************
# * need to grab and assign the patron information
# ****************************************************************************************************************************
$mysip->patron = $barcode;
$mysip->patronpwd = $pin;

# ****************************************************************************************************************************
# *  attempt to place the hold
# ****************************************************************************************************************************
//msgHold($mode, $expDate = '', $holdtype = '', $item = '', $title = '', $fee='N', $pkupLocation = '') {
$hold      = $mysip->msgHold('+', '', 2, $itemCode, '', '', $shortLocation);
$placeHold = $mysip->parseHoldResponse($mysip->get_message($hold));

# ****************************************************************************************************************************
# * assemble the response - holds whether the renewal was successful and the new due date
# ****************************************************************************************************************************
$holdInfo['data']['hold'] = array('ok' => $placeHold['fixed']['Ok'], 'transactionDate' => $placeHold['fixed']['TransactionDate']); 

# ****************************************************************************************************************************
# * Output to JSON
# ****************************************************************************************************************************
header('Content-Type: application/json');
echo json_encode($holdInfo);
?>