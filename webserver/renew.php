<?php
# ****************************************************************************************************************************
# * Last Edit: November 27, 2019
# * - renews items
# *
# * 11-27-19: refactored, cleaned up and commented code - CZ
# ****************************************************************************************************************************

# ****************************************************************************************************************************
# * include the required files
# ****************************************************************************************************************************
include_once('config.php');
include_once('sip2.php');

# ****************************************************************************************************************************
# * instanciate the SIP instance
# ****************************************************************************************************************************
$mysip = new sip2;

# ****************************************************************************************************************************
# * connect to SIP service; fail if not succcessful. if we pass this, then connection was successful
# ****************************************************************************************************************************
if(! $mysip->connect()) { 
 die();
}

# ****************************************************************************************************************************
# * Do a quick check to ensure that the login credentials are correct - for SIP
# ****************************************************************************************************************************
$sc_login = $mysip->msgLogin(SIP_LOGIN, SIP_PASSWORD);
$mysip->parseLoginResponse($mysip->get_message($sc_login));
  
# ****************************************************************************************************************************
# * Prep the patron information for checking - dummy out something just in case
# ****************************************************************************************************************************
$barcode  = "thisisadummybarcodeincaseitisleftblank";
$pin      = 1234567890;
$itemCode = 1234567890;

# ****************************************************************************************************************************
# * grab the passed variables
# ****************************************************************************************************************************
if (! empty($_GET['barcode'])) { $barcode = $_GET['barcode']; }
if (! empty($_GET['pin'])) { $pin = $_GET['pin']; }  
if (! empty($_GET['item'])) { $itemCode = $_GET['item']; }  

# ****************************************************************************************************************************
# * need to grab and assign the patron information
# ****************************************************************************************************************************
$mysip->patron = $barcode;
$mysip->patronpwd = $pin;

# ****************************************************************************************************************************
# *  attempt the renewal
# ****************************************************************************************************************************
$cko     = $mysip->msgRenew($itemCode);
$renewal = $mysip->parseRenewResponse($mysip->get_message($cko));

//print_r($renewal);
//die();

# ****************************************************************************************************************************
# * assemble the response - holds whether the renewal was successful and the new due date
# ****************************************************************************************************************************
$renewInfo['data']['renewal'] = array('renewal' => $renewal['fixed']['RenewalOk'], 'renewDate' => $renewal['variable']['AH'][0]); 

# ****************************************************************************************************************************
# * Output to JSON
# ****************************************************************************************************************************
header('Content-Type: application/json');
echo json_encode($renewInfo);
?>